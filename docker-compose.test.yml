version: '3.8'

services:
  mongodb-rs:
    image: mongo:6.0
    container_name: lrpc-mongodb-rs
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
    command: >
      --replSet rs0
      --bind_ip_all
    healthcheck:
      test: echo "db.adminCommand('ping')" | mongosh localhost:27017/test -u root -p password --quiet
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - lrpc-test-network

  mongodb-rs-init:
    image: mongo:6.0
    container_name: lrpc-mongodb-rs-init
    depends_on:
      mongodb-rs:
        condition: service_healthy
    entrypoint: >
      bash -c "
      mongosh --host mongodb-rs:27017 -u root -p password --authenticationDatabase admin --eval 'rs.initiate({\"_id\": \"rs0\", \"members\": [{\"_id\": 0, \"host\": \"mongodb-rs:27017\"}]})' || true
      echo 'Replica set initialized'
      "
    networks:
      - lrpc-test-network

networks:
  lrpc-test-network:
    driver: bridge
