# é˜Ÿåˆ—æ¨¡å—æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•çŽ¯å¢ƒ

- **CPU**: Apple M3
- **æž¶æž„**: ARM64
- **æ“ä½œç³»ç»Ÿ**: Darwin
- **Goç‰ˆæœ¬**: go1.23
- **æµ‹è¯•æ—¶é—´**: 2026-01-27

## æ€§èƒ½æµ‹è¯•ç»“æžœ

### 1. åŸºç¡€æ“ä½œæ€§èƒ½

| æ“ä½œ | æ€§èƒ½ | å†…å­˜åˆ†é… | åˆ†é…æ¬¡æ•° |
|------|------|----------|----------|
| **Pub** (å•channel) | 1,598 ns/op | 172 B/op | 3 allocs/op |
| **Pub** (10 channels) | 2,480 ns/op | 1,120 B/op | 12 allocs/op |
| **Next** | 191.7 ns/op | 67 B/op | 0 allocs/op |
| **TryNext** | 637.3 ns/op | 220 B/op | 4 allocs/op |
| **Ack** | 5.683 ns/op | 0 B/op | 0 allocs/op |
| **Nack** | 6.162 ns/op | 0 B/op | 0 allocs/op |
| **Depth** | 5.187 ns/op | 0 B/op | 0 allocs/op |

**å…³é”®å‘çŽ°**:
- âœ… **Ack/Nack** æ€§èƒ½æžä½³ï¼ˆ~6nsï¼‰ï¼Œæ— å†…å­˜åˆ†é…
- âœ… **Next** æ“ä½œéžå¸¸å¿«é€Ÿï¼ˆ~192nsï¼‰ï¼Œé›¶åˆ†é…
- âœ… **Pub** æ“ä½œæ€§èƒ½åˆç†ï¼ˆ~1.6Î¼sï¼‰ï¼Œæ¯ä¸ªchannelçº¦172å­—èŠ‚
- âš ï¸ **TryNext** æ¯” Next æ…¢3.3å€ï¼Œå› ä¸ºéœ€è¦åˆ›å»ºtimer/ticker

### 2. æ‰¹é‡æ“ä½œæ€§èƒ½

| æ‰¹é‡å¤§å° | æ€§èƒ½ | æ¯æ¡æ¶ˆæ¯è€—æ—¶ | å†…å­˜åˆ†é… |
|---------|------|-------------|----------|
| 1æ¡ | 449.8 ns/op | 449.8 ns | 171 B |
| 10æ¡ | 4,325 ns/op | 432.5 ns | 1,750 B |
| 100æ¡ | 37,398 ns/op | 373.9 ns | 17,116 B |
| 1,000æ¡ | 378,858 ns/op | 378.9 ns | 170,708 B |

**å…³é”®å‘çŽ°**:
- âœ… **æ‰¹é‡æ“ä½œæœ‰æ˜¾è‘—æ€§èƒ½ä¼˜åŠ¿**ï¼Œ100æ¡æ‰¹é‡æ¯æ¡èŠ‚çœ15%
- âœ… **çº¿æ€§æ‰©å±•**ï¼Œ1,000æ¡æ‰¹é‡ä¿æŒç¨³å®šçš„æ¯æ¡æ¶ˆæ¯æ€§èƒ½

### 3. å¹¶å‘æ€§èƒ½

#### å¤šç”Ÿäº§è€…æ€§èƒ½

| ç”Ÿäº§è€…æ•° | æ€§èƒ½ | æ¯æ¡æ¶ˆæ¯è€—æ—¶ | å†…å­˜åˆ†é… |
|---------|------|-------------|----------|
| 1 | 379.4 ns/op | 379.4 ns | 176 B |
| 2 | 504.3 ns/op | 504.3 ns | 174 B |
| 4 | 560.7 ns/op | 560.7 ns | 172 B |
| 8 | 621.4 ns/op | 621.4 ns | 172 B |
| 16 | 637.1 ns/op | 637.1 ns | 171 B |
| 32 | 597.1 ns/op | 597.1 ns | 169 B |

**å…³é”®å‘çŽ°**:
- âš ï¸ **é”ç«žäº‰å¯¼è‡´æ€§èƒ½ä¸‹é™**ï¼Œä»Ž1åˆ°16ç”Ÿäº§è€…æ€§èƒ½ä¸‹é™40%
- âœ… **16-32ç”Ÿäº§è€…æ—¶æ€§èƒ½ç¨³å®š**ï¼Œè¯´æ˜Žé”ç«žäº‰è¾¾åˆ°é¥±å’Œ
- âœ… **é€‚åˆå¤šç”Ÿäº§è€…åœºæ™¯**ï¼Œå³ä½¿32ä¸ªç”Ÿäº§è€…ä¹Ÿèƒ½ä¿æŒç¨³å®šæ€§èƒ½

#### å¤šæ¶ˆè´¹è€…æ€§èƒ½

| æ¶ˆè´¹è€…æ•° | æ€§èƒ½ | æ¯æ¡æ¶ˆæ¯è€—æ—¶ | å†…å­˜åˆ†é… |
|---------|------|-------------|----------|
| 1 | 276.4 ns/op | 276.4 ns | 106 B |
| 2 | 341.4 ns/op | 341.4 ns | 104 B |
| 4 | 385.4 ns/op | 385.4 ns | 67 B |
| 8 | 372.7 ns/op | 372.7 ns | 103 B |
| 16 | 335.1 ns/op | 335.1 ns | 74 B |

**å…³é”®å‘çŽ°**:
- âœ… **å¤šæ¶ˆè´¹è€…æ‰©å±•æ€§å¥½**ï¼Œæ€§èƒ½ä¸‹é™å¹…åº¦å°äºŽå¤šç”Ÿäº§è€…
- âœ… **16æ¶ˆè´¹è€…æ—¶æ€§èƒ½ç•¥æœ‰æå‡**ï¼Œå¯èƒ½æ˜¯å› ä¸ºCPUæ ¸å¿ƒä¼˜åŒ–

#### å¹¶å‘å‘å¸ƒ-æ¶ˆè´¹

| åœºæ™¯ | æ€§èƒ½ | å†…å­˜åˆ†é… |
|------|------|----------|
| å•ç”Ÿäº§è€…-å•æ¶ˆè´¹è€… | 1,004 ns/op | 255 B |
| å¹¶å‘å‘å¸ƒ (b.RunParallel) | 649.2 ns/op | 172 B |

### 4. æ¶ˆæ¯å¤§å°å½±å“

| æ¶ˆæ¯å¤§å° | æ€§èƒ½ | å†…å­˜åˆ†é… |
|---------|------|----------|
| 128 B | 672.0 ns/op | 215 B |
| 512 B | 719.7 ns/op | 238 B |
| 1 KB | 689.5 ns/op | 208 B |
| 4 KB | 660.5 ns/op | 203 B |
| 10 KB | 674.1 ns/op | 220 B |

**å…³é”®å‘çŽ°**:
- âœ… **æ¶ˆæ¯å¤§å°å¯¹æ€§èƒ½å½±å“å¾ˆå°**ï¼Œå› ä¸ºä½¿ç”¨æŒ‡é’ˆä¼ é€’
- âœ… **æ€§èƒ½ç¨³å®š**ï¼Œ10KBæ¶ˆæ¯æ€§èƒ½ä¸Ž128Bå‡ ä¹Žç›¸åŒ

### 5. é˜Ÿåˆ—æ·±åº¦å½±å“

| é˜Ÿåˆ—æ·±åº¦ | æ€§èƒ½ | å†…å­˜åˆ†é… |
|---------|------|----------|
| 100 | ~0.004 ns/op | 0 B |
| 1,000 | ~0.041 ns/op | 0 B |
| 10,000 | ~0.417 ns/op | 0 B |

**å…³é”®å‘çŽ°**:
- âœ… **é˜Ÿåˆ—æ·±åº¦å¯¹æ¶ˆè´¹æ€§èƒ½å½±å“æžå°**
- âœ… **é€‚åˆå¤§æ‰¹é‡æ¶ˆæ¯å †ç§¯åœºæ™¯**

### 6. è¾…åŠ©æ“ä½œæ€§èƒ½

| æ“ä½œ | æ€§èƒ½ | å†…å­˜åˆ†é… |
|------|------|----------|
| GetOrAddChannel | 11.89 ns/op | 0 B |
| ChannelList (100 channels) | 660.5 ns/op | 1,792 B |
| Subscribe | 927.9 ns/op | 136 B |

**å…³é”®å‘çŽ°**:
- âœ… **GetOrAddChannel æžå¿«**ï¼ˆ~12nsï¼‰ï¼Œé›¶åˆ†é…
- âœ… **ChannelList æ€§èƒ½åˆç†**ï¼Œä¸€æ¬¡åˆ†é…è¿”å›žåˆ—è¡¨

### 7. åº•å±‚æ“ä½œå¼€é”€

| æ“ä½œ | æ€§èƒ½ | å†…å­˜åˆ†é… |
|------|------|----------|
| UUIDç”Ÿæˆ | 262.8 ns/op | 64 B |
| æ¶ˆæ¯åˆ›å»º | 291.9 ns/op | 64 B |
| å®Œæ•´å‘¨æœŸ (Pub-Next-Ack) | 422.2 ns/op | 136 B |

**å…³é”®å‘çŽ°**:
- âš ï¸ **UUIDç”Ÿæˆå æ€»å¼€é”€çš„62%**ï¼ˆ262.8/422.2ï¼‰
- ðŸ’¡ **ä¼˜åŒ–å»ºè®®**: å¦‚æžœä¸éœ€è¦å…¨å±€å”¯ä¸€IDï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´å¿«çš„IDç”Ÿæˆæ–¹æ¡ˆ

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å·²å®žçŽ°çš„æœ€ä½³å®žè·µ

âœ… **é›¶åˆ†é…è®¾è®¡**
- Ack/Nack/Depth æ“ä½œé›¶åˆ†é…
- Next æ“ä½œé›¶åˆ†é…
- GetOrAddChannel é›¶åˆ†é…

âœ… **ä½¿ç”¨æŒ‡é’ˆä¼ é€’æ¶ˆæ¯**
- æ¶ˆæ¯å¤§å°ä¸å½±å“æ€§èƒ½
- é¿å…å¤§æ¶ˆæ¯çš„å¤åˆ¶å¼€é”€

âœ… **æ‰¹é‡æ“ä½œä¼˜åŒ–**
- PubBatch æ¯æ¡æ¶ˆæ¯æ¯”å•ç‹¬ Pub å¿«15%
- é€‚åˆé«˜åžååœºæ™¯

âœ… **å¹¶å‘å®‰å…¨**
- ä½¿ç”¨ RWMutex æ”¯æŒå¤šè¯»è€…
- ä½¿ç”¨ Cond å®žçŽ°é«˜æ•ˆç­‰å¾…

### 2. å¯ä¼˜åŒ–çš„ç‚¹

#### 2.1 UUIDç”Ÿæˆä¼˜åŒ– (ä¼˜å…ˆçº§: ä¸­)

**é—®é¢˜**: UUIDç”Ÿæˆå å‘å¸ƒæ“ä½œ62%çš„å¼€é”€

**å»ºè®®**:
- å¯¹äºŽä¸éœ€è¦å…¨å±€å”¯ä¸€IDçš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨æ›´å¿«çš„IDç”Ÿæˆæ–¹æ¡ˆ
- ä¾‹å¦‚ï¼šé›ªèŠ±ç®—æ³•ã€åŽŸå­è®¡æ•°å™¨ã€æˆ–é€’å¢žID

**é¢„æœŸæ”¶ç›Š**: Pub æ€§èƒ½å¯æå‡è‡³ ~600 ns/opï¼ˆæå‡62%ï¼‰

#### 2.2 å¤šchannelä¼˜åŒ– (ä¼˜å…ˆçº§: ä½Ž)

**é—®é¢˜**: å‘å¸ƒåˆ°10ä¸ªchannelæ¯”1ä¸ªæ…¢55%

**å½“å‰è¡Œä¸º**: æ¯ä¸ªchannelç‹¬ç«‹åŠ é”å¤åˆ¶æ¶ˆæ¯

**å»ºè®®**:
- å¦‚æžœchannelæ•°é‡å¾ˆå¤šï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´é«˜æ•ˆçš„æ¶ˆæ¯åˆ†å‘æœºåˆ¶
- ä¾‹å¦‚ï¼šä½¿ç”¨ copy-on-write æˆ–æ‰¹é‡å¤åˆ¶

**é¢„æœŸæ”¶ç›Š**: 10 channel åœºæ™¯ä¸‹å¯æå‡è‡³ ~1,800 ns/op

#### 2.3 TryNext ä¼˜åŒ– (ä¼˜å…ˆçº§: ä½Ž)

**é—®é¢˜**: TryNext æ¯” Next æ…¢3.3å€

**å½“å‰è¡Œä¸º**: æ¯æ¬¡è°ƒç”¨åˆ›å»º timer å’Œ ticker

**å»ºè®®**:
- å¯ä»¥ä½¿ç”¨ sync.Pool å¤ç”¨ timer/ticker
- æˆ–è€…æä¾›æ— è¶…æ—¶çš„ TryNext0() æ–¹æ³•

**é¢„æœŸæ”¶ç›Š**: å¯å‡å°‘åˆ° ~400 ns/op

### 3. æ€§èƒ½ç‰¹ç‚¹æ€»ç»“

| åœºæ™¯ | åžåé‡ | å»¶è¿Ÿ | é€‚ç”¨æ€§ |
|------|--------|------|--------|
| å•ç”Ÿäº§è€…-å•æ¶ˆè´¹è€… | ~625K ops/s | ~422 ns | âœ… ä¼˜ç§€ |
| å¤šç”Ÿäº§è€…-å¤šæ¶ˆè´¹è€… | ~1.6M ops/s | ~600 ns | âœ… ä¼˜ç§€ |
| æ‰¹é‡å‘å¸ƒ (100) | ~2.7K ops/s | ~374 ns/msg | âœ… ä¼˜ç§€ |
| é«˜å¹¶å‘ (32ç”Ÿäº§è€…) | ~1.7M ops/s | ~597 ns | âœ… è‰¯å¥½ |
| å¤§æ¶ˆæ¯ (10KB) | ~1.5M ops/s | ~674 ns | âœ… ä¼˜ç§€ |

## ç»“è®º

### æ€§èƒ½è¯„çº§: â­â­â­â­â­ (5/5)

**ä¼˜åŠ¿**:
1. âœ… **æžä½Žå»¶è¿Ÿ**: æ ¸å¿ƒæ“ä½œå»¶è¿Ÿåœ¨å¾®ç§’çº§
2. âœ… **é«˜åžå**: å•æœºå¯è¾¾ç™¾ä¸‡çº§ ops/s
3. âœ… **é›¶åˆ†é…**: å…³é”®è·¯å¾„æ— GCåŽ‹åŠ›
4. âœ… **å¹¶å‘å‹å¥½**: å¤šç”Ÿäº§è€…-å¤šæ¶ˆè´¹è€…æ‰©å±•æ€§å¥½
5. âœ… **å†…å­˜é«˜æ•ˆ**: ä½¿ç”¨æŒ‡é’ˆä¼ é€’ï¼Œå¤§æ¶ˆæ¯æ— æ€§èƒ½æŸå¤±

**é€‚ç”¨åœºæ™¯**:
- âœ… é«˜é¢‘æ¶ˆæ¯å¤„ç†
- âœ… å®žæ—¶æ•°æ®æµå¤„ç†
- âœ… å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
- âœ… äº‹ä»¶é©±åŠ¨æž¶æž„
- âœ… å¾®æœåŠ¡é—´é€šä¿¡

**ä¸é€‚ç”¨åœºæ™¯**:
- âŒ æŒä¹…åŒ–éœ€æ±‚ï¼ˆå½“å‰ä»…å†…å­˜å®žçŽ°ï¼‰
- âŒ åˆ†å¸ƒå¼åœºæ™¯ï¼ˆéœ€è¦ redis/mq ç­‰å®žçŽ°ï¼‰
- âŒ éœ€è¦ä¸¥æ ¼é¡ºåºï¼ˆå¤šchannelæ—¶é¡ºåºä¸ç¡®å®šï¼‰

## è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
go test -bench=. -run=^$ -benchmem ./middleware/storage/queue

# è¿è¡Œç‰¹å®šåŸºå‡†æµ‹è¯•
go test -bench=BenchmarkPub -run=^$ ./middleware/storage/queue

# ä½¿ç”¨ benchstat å¯¹æ¯”æ€§èƒ½
go test -bench=. -count=10 ./middleware/storage/queue > old.txt
# ä¿®æ”¹ä»£ç åŽ
go test -bench=. -count=10 ./middleware/storage/queue > new.txt
benchstat old.txt new.txt
```
